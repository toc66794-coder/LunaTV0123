# MoonTV 電視網頁版優化計畫 (遙控器交互)

這個計畫旨在透過在現有的 Next.js 專案中增加「空間導航 (Spatial Navigation)」功能，讓電視遙控器能直覺地操作網頁，同時 100% 保留現有的播放器功能。

## 核心設計理念

- **瀏覽器原生**：繼續使用 Next.js 和 HLS.js，保證「去廣告」和「備速」邏輯與手機端一致。
- **空間導航 (Focus Management)**：引入空間導航庫，讓遙控器方向鍵能在按鈕、影片卡片間跳轉。
- **自動偵測**：當偵測到電視 User-Agent 或手動開啟「電視模式」時，自動切換為大字體、大格子的電視佈局。

---

## 預計實作步驟

### 1. 隔離式架構設計 (Zero Impact on Mobile)

- **專屬路由**：`/src/app/tv` (電視端入口)。
- **專屬組件**：`/src/components/tv` (含 `TVVideoPlayer.tsx`, `TVVideoCard.tsx`)。
- **共享邏輯**：僅共用 `/src/lib` 下的搜尋、解析與資料庫 API，UI 代碼完全隔離，確保 100% 不影響手機版。

### 2. 自研焦點管理 (Custom Spatial Navigation)

- **技術方案**：考量電視端環境穩定性，不使用外部 npm 套件，改用自研 `useTvFocus` Hook。
- **2D 導航**：基於 `getBoundingClientRect()` 計算座標，實現直覺的方向鍵跳選。
- **視覺強化**：選中項自動放大幅度 1.1x 並疊加「Luna Blue」發光邊框。

### 3. 遙控器深度交互 (Leanback UX)

- **OK/Enter**：觸發播放/暫停。
- **左右鍵**：快進/快退 10 秒。
- **長按 OK**：觸發 3 倍速播放 (繼承手機端操作邏輯)。
- **返回鍵**：智慧攔截，優先關閉選單，其次退出全螢幕。
- **去廣告**：因為是瀏覽器模式，可繼續使用 `hls.js` 的片段攔截邏輯，避開伺服器代理。

---

## UI 設計細節 (Leanback UI)

為了讓電視端看起來更有質感，我們將遵循以下設計規範：

### 1. 視覺層次

- **海報牆佈局**：由目前的手機垂直列表改為「橫向滾動行情 (Row-based Rails)」。
- **焦點特效 (Focus State)**：當焦點移到某個影片時，該海報會：
  - **Scale Up (放大幅度 1.1x)**。
  - **新增亮框 (Glowing Border)**。
  - **顯示陰影 (Drop Shadow)**。

### 2. 操作反饋

- **側邊導航欄**：使用玻璃擬態 (Glassmorphism) 毛玻璃效果，只有在焦點移到最左側時才展開文字。
- **播放器 Overlay**：在電視上按任何鍵會喚起播放控制欄，顯示剩餘時間與目前時間，3 秒後自動淡出。

### 3. 字體與間距

- 使用更大字重與字體大小 (推薦使用 Inter 或 Roboto)。
- 增加控制項之間的呼吸感 (Gap 至少 24px)。

---

## 遙控器交互技術規格 (Remote Control Specs)

為了讓網頁版在電視上表現得像原生 App，我們將實作以下交互邏輯：

### 1. 按鍵映射 (Key Mapping)

我們將監聽全域 `keydown` 事件，並處理標準的電視遙控器 KeyCodes：

- **方向鍵 (37, 38, 39, 40)**：映射為空間導航的「上、下、左、右」焦點移動。
- **確認鍵 (Enter/13)**：觸發目前焦點項目的點擊事件 (如播放影片、選取集數)。
- **返回鍵 (Back/27 或 10009)**：
  - 如果在播放中：關閉播放器，回到影片詳情頁。
  - 如果在搜尋中：關閉搜尋鍵盤。
- **播放/暫停專用鍵**：若遙控器有此按鍵，直接對應 Artplayer 的 play/pause。

### 2. 空間導航邏輯 (Spatial Navigation)

- 使用 **2D 搜尋演算法**：當按下「右」時，程式會計算目前焦點右側最近的組件，並自動將 `focus` 轉移過去。
- **自動對焦 (Initial Focus)**：進入頁面後，系統會自動將焦點放在「第一個影片卡片」或「首個選單項」。

### 3. 播放狀態交互 (Playback Controls)

當影片**全螢幕播放**時，遙控器的功能會自動切換為播放控制模式：

- **左右鍵**：即時快進/快退 10 秒 (畫面同步顯示進度條提示)。
- **上下鍵**：
  - **向上**：顯示自定義控制選單 (切換倍速、畫質、選集)。
  - **向下**：顯示影片基礎資訊或進度條。
- **長按 OK**：觸發 3 倍速播放 (模擬手機端的長按功能)。

---

## 電視交互魯棒性與邊緣案例處理 (UX Robustness)

為了最大程度減少電視端測試次數，我們將在程式碼層級預防以下常見問題：

### 1. 焦點遺失救援機制 (Focus Rescue)

- **問題**：當用戶關閉彈窗或切換選集時，原有的焦點元素會消失，導致遙控器失效。
- **對策**：實作「自動回退焦點」。每當 UI 更新或組件卸載時，系統若偵測到當前無焦點，會自動將焦點強制移至最接近的父容器或頁面第一個可聚焦項。

### 2. 視窗滾動同步 (Viewport Sync)

- **問題**：遙控器移動焦點時，瀏覽器不會自動捲動，導致選中的東西在畫面外。
- **對策**：使用 `scrollIntoView({ behavior: 'smooth', block: 'center' })`。確保當焦點移動到新的影片卡片時，該卡片會自動滾動到螢幕中央。

### 3. 返回鍵行為管理 (Back Button Hijack)

- **問題**：電視遙控器的返回鍵常會直接觸發瀏覽器退出。
- **對策**：攔截 `popstate` 或特定返回 KeyCode。
  - 第一優先：關閉當前開啟的選單/控制欄。
  - 第二優先：退出播放器。
  - 第三優先：才允許返回上一頁。

### 4. 按鍵防抖與長按判定 (Input Debouncing)

- **問題**：遙控器按鍵容易產生重複觸發，導致焦點「連跳」。
- **對策**：實作 `key-repeat-limit`。過濾掉極短時間內的連續重複按鍵，只有真正的「長按」行為會被判定為「3 倍速」指令。

---

## 驗證與測試計畫

### [測試] 遙控器循環導航

- 驗證焦點是否會在畫面的最邊緣自動循環，或正確停止。

### [測試] 隱現邏輯

- 驗證在播放影片時，一段時間不操作遙控器，所有 UI 是否會自動隱藏，按任意方向鍵喚醒。
